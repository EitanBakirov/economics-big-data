---
title: "big data first task"
author: "Ariel & Eitan & Yuval"
date: "2024-07-27"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load libraries
```{r libraries}
library(pacman)
pacman::p_load(
  tidyverse, 
  readr, 
  skimr, 
  knitr,
  dplyr,
  tidyr
)
library(ggplot2)
library(scales)
library(lubridate)
```

## Load Data
```{r}
listings_data <- read_csv('listings_clean.csv')
calendar_data <- read_csv('calendar_clean.csv')
```


# Part 1 - Descriptive Statistics
```{r}
summary(listings_data)
skim(listings_data)
```
- no missing values for the price_dollars

- המחיר הוא מחיר קטלוג כלומר המחיר שיש בטבלה הזו זה המחיר שבכל הנכס ראה לנכון לרשום לראושנה.
------------------------------------------------------------------

## Single Variable Visualizations
### Plot 1: Distribution of Prices

```{r}
#ggplot(listings_data, aes(x = price_dollars)) +
#  geom_histogram(fill = "blue", color = "black", bins = 50) +
#  labs(title = "Distribution of Nightly Prices", x = "Price (Dollars)", y = "Frequency") +
#  theme_minimal()
```

```{r, echo=TRUE, fig.width=12, fig.height=6}
# Set the number of bins
# num_bins <- 50

# Calculate the bin width
# bin_width <- (max(listings_data$price_dollars, na.rm = TRUE) - min(listings_data$price_dollars, na.rm = TRUE)) / num_bins

# Create the histogram with annotations for the price range
# ggplot(listings_data, aes(x = price_dollars)) +
# geom_histogram(fill = "blue", color = "black", bins = num_bins) +
#  labs(title = "Distribution of Nightly Prices", x = "Price (Dollars)", y = "Frequency") +
#  theme_minimal() +
#  stat_bin(binwidth = bin_width, geom = "text", aes(label = ..count..), vjust = -0.5) +
#  scale_x_continuous(breaks = seq(0, max(listings_data$price_dollars, na.rm = TRUE), bin_width),
#                     labels = scales::dollar_format(prefix = "$", big.mark = ",")) +
#  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r, echo=TRUE, fig.width=14, fig.height=10}
# Create a histogram with 50 bins
hist_data <- hist(listings_data$price_dollars, 
                  breaks = 50, 
                  plot = FALSE)  # Create histogram data without plotting

# Plot the histogram
plot(hist_data, 
     main = "Distribution of Price (Dollars)", 
     xlab = "",
     ylab = "Frequency", 
     col = "blue", 
     border = "black", 
     xaxt = 'n')  # Suppress x-axis labels initially

# Add custom x-axis labels with price ranges
bin_midpoints <- hist_data$mids  # Midpoints of bins
bin_labels <- paste0("[", round(hist_data$breaks[-length(hist_data$breaks)], 2), 
                     ", ", round(hist_data$breaks[-1], 2), ")")  # Bin range labels
axis(1, at = bin_midpoints, labels = bin_labels, las = 2, cex.axis = 0.7)  # Custom x-axis

# Add frequency labels at the top of each bin
text(bin_midpoints, hist_data$counts, labels = hist_data$counts, pos = 3, cex = 0.8)

```
במחשבה שניה אני לא בטוחה עד כמה זה רלוונטי!
לא ממש רואים פה משהו...

אפשר אולי להוסיף כגרף רביעי

* bins = 50 is the number of intervals (bins) into which the data range is divided for the histogram. 
Setting bins = 50 means the entire range of price data is divided into 50 equal intervals.

* X-axis (Price in Dollars): This axis shows the nightly prices of the Airbnb listings. The values range from 0 to over 4000 dollars.

* Y-axis (Frequency): This axis represents the number of listings that fall into each price range (bin).

* Observations - תצפיות: 
* Skewed Distribution (חלוקה מוטה): The plot shows a highly skewed distribution, with most listings clustered at the lower end of the price scale. This indicates that the majority of listings have relatively low nightly rates.

* Outliers: There are a few listings with significantly higher prices, stretching the distribution far to the right. These could be luxury or unique properties that command higher rates.

* Zero or Near-Zero Prices: A spike near the zero price mark might indicate data entry errors or special pricing strategies like promotional offers or placeholders. (שגיאה בנתונים)


* Strategies to Raise Revenue - חיבור לשאלה 4:
TODO

------------------------------------------------------------------

### Plot 2: Distribution of Review Scores
```{r}
#ggplot(listings_data, aes(x = review_scores_rating)) +
#  geom_histogram(fill = "green", color = "black", bins = 10) +
#  labs(title = "Distribution of Review Scores", x = "Review Scores Rating", y = "Frequency") +
#  theme_minimal()
```

```{r, echo=TRUE, fig.width=14, fig.height=10}
# Create a histogram with 10 bins
hist_data <- hist(listings_data$review_scores_rating, 
                  breaks = 10, 
                  plot = FALSE)  # Create histogram data without plotting

# Plot the histogram
plot(hist_data, 
     main = "Distribution of Review Scores", 
     xlab = "Review Scores Rating", 
     ylab = "Frequency", 
     col = "blue", 
     border = "black", 
     xaxt = 'n')  # Suppress x-axis labels initially

# Add custom x-axis labels with price ranges
bin_midpoints <- hist_data$mids  # Midpoints of bins
bin_labels <- paste0("[", round(hist_data$breaks[-length(hist_data$breaks)], 2), 
                     ", ", round(hist_data$breaks[-1], 2), ")")  # Bin range labels
axis(1, at = bin_midpoints, labels = bin_labels, las = 2, cex.axis = 0.7)  # Custom x-axis

# Add frequency labels at the top of each bin
text(bin_midpoints, hist_data$counts, labels = hist_data$counts, pos = 3, cex = 0.8)
```

* Observations - תצפיות: 
* High Concentration of Top Scores: The histogram shows a significant concentration of listings with review scores around 100, indicating that many listings are highly rated by guests. This suggests a generally positive guest experience across many properties. - ריכוז גבוה של ציונים סביב ה100

* Sparse Low Scores: There are very few listings with low review scores, indicating either high satisfaction or that properties with poor ratings are less common or less frequently reviewed. - מעט ציונים נמוכים

* Gap in Middle Scores: There is a noticeable gap in the mid-range scores (25-75), suggesting that listings tend to either be rated very highly or not at all. This could be due to fewer guests leaving reviews or an issue with the scoring system. - רוב הציונים גבוהים ממש או נמוכים

* התוצאות שקיבלנו קצת מוזרות 
איך זה שהרוב 100? מה אין ציונים גרועים? אולי זה קשור לערכים חסרים

```{r}
# Checking the number and percentage of NA (missing) values in the 'review_scores_rating' column
num_na_reviews <- sum(is.na(listings_data$review_scores_rating))
total_reviews <- nrow(listings_data)
percent_na_reviews <- (num_na_reviews / total_reviews) * 100
num_na_reviews
percent_na_reviews
```
Significant percentage of missing values (22.68%)!

Possible Explanations:
הסברים אפשריים לתואה שקיבלנו בגרף:
1. Bias in Review Submissions:
- Happy Guests Are More Likely to Review: Often, guests who have a very positive experience are more motivated to leave reviews, especially if they feel strongly about their experience. This can lead to a skew in the data where high scores dominate.
- Cultural or Platform Bias: In some cultures or platforms, there might be a tendency to avoid leaving negative feedback unless the experience was extremely poor. This cultural bias can result in predominantly high ratings.

2. Selection Bias:
- Listing Curation: Airbnb hosts might selectively encourage satisfied guests to leave reviews, while not prompting those who might leave lower scores. 
נעודד רק את אלו שנהנו להשאיר ציון
- ncentives for Positive Reviews: Sometimes, hosts offer incentives for positive reviews, intentionally or not, which can skew the distribution towards higher scores.
תמריצים להשארת ציון גבוה

3. Missing Data Impact:
- Non-Reviewed Stays: The missing review data (22.68%) could represent stays that were either not reviewed by guests or the reviews were withheld. These missing reviews could potentially include more negative experiences.
- Systematic Omission: If the missing data disproportionately represents lower scores, this would skew the visible data towards higher scores. It’s essential to understand why these values are missing—whether due to guest inaction, system errors, or intentional omission.
האם הערכים החסרים מעידים על ציונים נמוכים?
אולי זה לא מושכר ולכן יש ערכים חסרים ואין לזה ציון!

* Strategies to Raise Revenue - חיבור לשאלה 4:
רוב הציונים אכן גבוהים, יכול להראות קצת חשוד כי יכול להיות שיש פה רמאות כלשהי(גם אם לא במכוון)
על כן נעדיף להסתכל על זה בעין חשדנית
נרצה לבדוק יותר מאוחר את הקשר למחיר ואת הקשר להזמנות שבוצעו בפועל.


------------------------------------------------------------------
### Plot 3: Distribution of the number of beds
```{r}
ggplot(listings_data, aes(x = factor(beds))) +
  geom_bar(fill = "purple", color = "black") +
  labs(title = "Distribution of Number of Beds in Listings", x = "Number of Beds", y = "Frequency") +
  theme_minimal()
```

למה בחרנו בזה?:
- Variable Choice: Number of Beds - The number of beds in a listing is crucial as it determines the accommodation capacity, influencing both pricing and the target market. Listings with more beds can attract larger groups, such as families or group travelers, potentially leading to higher per-night revenue. This variable also allows targeting different market segments, which can significantly affect booking rates and pricing strategies.
מדובר בפרמטר קריטי שקובע את קיבולת האירוח ועל מס' הלנים.

ניתן לראות שרוב הדיור שמושכר הוא עם מיטה אחת-2, זה יכול להיות מעט בעייתי בעיקר אם רוצים להגדיל הכנסות.
דיור בעל מספר גדול יותר של מיטות יהיה מושכר בעלות יותר גדולה מאחר ויש קשר בין גודל הנכס למספר המיות בו, 
הגיוני שנכנס גדול יותר יכיל יותר מיטות ולכן יהיה מושכר ביותר כסף.
הייתי ממליצה להציע יותר נכסים בעלי מספר גדול יותר של מיטות (זה גם מכניס יותר כסף וגם מגדיל את מגוון ההיצע שיש לאירביאנדבי להציע)


------------------------------------------------------------------
### Plot 4: Distribution of Host Response Times

```{r, echo=TRUE, fig.width=14, fig.height=8}
# Count the occurrences of each response category
response_counts <- table(listings_data$host_response_time)

# Set up the plotting area with more space for axis labels
par(mar = c(7, 4, 4, 2) + 0.1)  # Adjust bottom margin to provide more space

# Plot the bar chart with adjusted y-axis limit
bp <- barplot(response_counts,
              main = "Distribution of Host Response Times",
              ylab = "Frequency",
              col = "lightblue",
              las = 1,  # Make the labels horizontal
              cex.names = 1.2,  # Increase the size of the axis labels
              ylim = c(0, 1500))  # Set y-axis limit up to 1400

# Add frequency labels above each bar
text(x = bp, y = response_counts, labels = response_counts, pos = 3, cex = 1.0, col = "black")

# Reset margins to default
par(mar = c(5, 4, 4, 2) + 0.1)

```
לא אומר הרבה....
זה תוצאות טובות שהרוב עונים מהר
כנראה ימחק!

------------------------------------------------------------------
### Plot 5: Distribution of property Type
```{r, echo=TRUE, fig.width=14, fig.height=8}
# Count the occurrences of each property type
response_counts <- table(listings_data$property_type)

# Set up the plotting area with more space for axis labels
par(mar = c(12, 4, 4, 2) + 0.1)  # Increase bottom margin for rotated labels

# Plot the bar chart with adjusted y-axis limit
bp <- barplot(response_counts,
              main = "Distribution of Property Types",
              ylab = "Frequency",
              col = "lightblue",
              las = 2,  # Rotate the labels to be perpendicular to the axis
              cex.names = 0.8,  # Adjust size of axis labels
              ylim = c(0, 3000))  # Set y-axis limit

# Add frequency labels above each bar
text(x = bp, y = response_counts, labels = response_counts, pos = 3, cex = 0.8, col = "black")

# Reset margins to default
par(mar = c(5, 4, 4, 2) + 0.1)

```

חסר מגוון!
אולי הגדלת המגוון עשויה להביא סוג נוסף של לקוחות שמעוניין להשכיר דיור אחר ולא רק דירות ובכך להגדיל את הרווחים.

The graph shows a predominance of apartments (2,612 listings) among available rental properties, with other types like houses (562 listings) being far less common. This indicates a lack of variety in accommodations. To attract a broader customer base, the platform should encourage more listings of diverse property types, such as boats, camper/RVs, and villas. Increasing variety can appeal to niche markets and potentially boost bookings. Diversifying property offerings could lead to increased profits by catering to different traveler preferences.

* Strategies to Raise Revenue - חיבור לשאלה 4:
נמליץ באופן כללי להציע מגוון רחב יותר של נכסים על מנת להגיע ליותר סוגי אנשים ולעלות על צרכיהם.

------------------------------------------------------------------

## Multi-Variable Analysis
### Plot 1: Average Review Scores by Neighbourhood with Listing Count

```{r, echo=TRUE, fig.width=14, fig.height=8}

# Filter out rows with missing review_scores_location or num_listings
neighborhood_data <- listings_data %>%
  group_by(neighbourhood) %>%
  summarise(
    avg_review_score = mean(review_scores_location, na.rm = TRUE),
    num_listings = n()
  ) %>%
  filter(!is.na(avg_review_score) & !is.na(num_listings))

# Plot 1: Average Review Scores by Neighbourhood with Listing Count
ggplot(neighborhood_data, aes(x = reorder(neighbourhood, -avg_review_score), y = avg_review_score, size = num_listings)) +
  geom_point(alpha = 0.6, color = "blue") +
  scale_size_area(max_size = 20) +
  labs(title = "Average Review Scores by Neighbourhood with Listing Count",
       x = "Neighbourhood",
       y = "Average Review Score (Location)",
       size = "Number of Listings") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
    plot.title = element_text(hjust = 0.5)
  )

```

The bubble plot shows the relationship between average review scores for location and the number of listings across different neighborhoods. Notably, neighborhoods like Brookline and Chestnut Hill have high average review scores, suggesting they are well-regarded by guests for their location. However, these areas also have fewer listings, indicating potential for growth. On the other hand, neighborhoods like Allston-Brighton and Back Bay have a high number of listings but comparatively lower average review scores, suggesting these areas are popular but might benefit from improvements in location-related amenities.

Recommendation: To maximize profitability and guest satisfaction, consider investing in increasing the number of listings in high-scoring neighborhoods, as these areas are already preferred by guests for their location. Additionally, improving amenities and services in lower-scoring but popular neighborhoods could enhance guest experiences, potentially leading to higher ratings and increased bookings. This balanced approach could optimize both guest satisfaction and revenue growth.

אזורים שנחשבים לטובים עדיף להשכיר בהם יותר!

------------------------------------------------------------------

### Plot 2: Relationship Between Review Scores and Prices by Number of Beds

```{r, echo=TRUE, fig.width=14, fig.height=8}
# Filter out missing values
#data_filtered <- listings_data %>%
#  filter(!is.na(price_dollars) & !is.na(review_scores_rating) & !is.na(beds))

# Scatter Plot with Facets by Number of Beds
#ggplot(data_filtered, aes(x = review_scores_rating, y = price_dollars)) +
#  geom_point(alpha = 0.6, color = "blue") +
#  facet_wrap(~ beds, scales = "free_y", ncol = 3) +
#  labs(title = "Review Scores vs Price by Number of Beds",
#       x = "Review Scores Rating",
#       y = "Price (Dollars)") +
#  theme_minimal() +
#  theme(strip.text = element_text(size = 10),
#        plot.title = element_text(hjust = 0.5))
```

הסבר:
- Review Scores on the X-axis: Displays how guest ratings relate to pricing.
- Price on the Y-axis: Shows the variation in prices for listings with different review scores.
- Facets for Number of Beds: Each facet represents a different bed category, helping to see patterns or trends specific to each category.

הגרף הזה לא ממש עוזר לי להבין משהו - כנראה ימחק! 


------------------------------------------------------------------

### Plot 3: Correlation of Various Review Aspects with Overall Review Score

```{r}
# Calculate correlation coefficients
correlations <- listings_data %>%
  select(review_scores_rating, review_scores_communication, review_scores_checkin, review_scores_cleanliness, review_scores_accuracy) %>%
  summarise(across(starts_with("review_scores"), ~cor(review_scores_rating, ., use = "complete.obs"))) %>%
  pivot_longer(cols = -review_scores_rating, names_to = "Aspect", values_to = "Correlation")

# Plot the correlations
ggplot(correlations, aes(x = reorder(Aspect, Correlation), y = Correlation, fill = Aspect)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  labs(title = "Correlation of Various Review Aspects with Overall Review Score Rating", 
       x = "Review Aspect", 
       y = "Correlation Coefficient") +
  theme_minimal() +
  scale_fill_brewer(palette = "Blues")
```
תובנות:
The bar plot above illustrates the correlation between various review aspects (cleanliness, accuracy, communication, and check-in) and the overall review score rating for Airbnb listings. 
The higher the correlation coefficient, the stronger the relationship between the aspect and the overall rating.
In this case, "cleanliness" has the highest correlation with the overall review score, followed by "accuracy," "communication," and "check-in." 
This suggests that guests value cleanliness the most when rating their stay, indicating that hosts should prioritize maintaining a clean environment.
Additionally, focusing on accuracy in listings, effective communication, and a smooth check-in process can also enhance guest satisfaction and lead to higher ratings.
Therefore, hosts are recommended to pay particular attention to cleanliness, as it significantly influences guest perceptions and overall satisfaction.

ניקיון משפיע הכי הרבה כדאי למארח לשים לב לזה, זה יעלה את הציון שלו ועשוי להביא לו יותר לקוחות ובכך להעלות רווחים.

------------------------------------------------------------------

### Graph 4: Average Price by Review Score Bands and Number of Beds

```{r}

# Define bins for review scores
bins <- cut(listings_data$review_scores_rating, breaks = seq(0, 100, by = 20), include.lowest = TRUE)

# Add bins to the data
listings_data$score_bins <- bins

# Calculate average price for each bin and number of beds
average_price_by_bin_beds <- aggregate(price_dollars ~ score_bins + beds, data = listings_data, FUN = mean, na.rm = TRUE)

# Plot the average price by review score bins and number of beds
ggplot(average_price_by_bin_beds, aes(x = score_bins, y = price_dollars, fill = as.factor(beds))) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Average Price by Review Score Bands and Number of Beds", x = "Review Score Bands", y = "Average Price (Dollars)", fill = "Number of Beds") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```

הסבר - מה רואים:
This graph displays the average price of Airbnb listings across different review score bands, segmented by the number of beds.
The x-axis represents review score bands, while the y-axis shows the average price in dollars. 
Different colors indicate the number of beds in each listing.
הצגנו את הציונים השונים תוך קיבוץ לקבוצות ואת המחיר שנדרש עבור כל קבוצת ציון, כאשר חילקנו למספר חדרים - זאת על מנת לנקות את השפעת גודל הנכס.

תובנות:
From the graph, it is evident that the relationship between review scores and price varies by the number of beds. 
Listings with one bed show less variation in price across different review score bands, suggesting that review scores may not significantly impact pricing for these smaller units. 
In contrast, listings with more beds, particularly those in higher review score bands (60-100), generally command higher prices. 
This trend implies that larger listings with better reviews can justify higher prices.

המלצה:
Property owners, especially those with multiple beds, should focus on improving their review scores to enhance their value perception. 
By investing in the quality and amenities of their properties, they can achieve higher ratings, which in turn can justify higher nightly rates and increase overall profitability.

נמליץ לבעלי הנכסים עם ציונים גבוהים להעלות את המחיר לנכס שלהם - הם יכולים לעשות זאת כי השקעה שווה כסף.


------------------------------------------------------------------


# Part 2 - Business Metrics

## Merge the CSVs
```{r}
# Rename price_dollars to org_price in listings_data
listings_data_copy <- listings_data %>% rename(org_price = price_dollars)
# Ensure the host_since is in date format and extract year-month
listings_data_copy$host_since <- as.Date(listings_data_copy$host_since, format="%Y-%m-%d")
listings_data_copy$host_since_month <- format(listings_data_copy$host_since, "%Y-%m")

# Create copy
calendar_data_copy <- calendar_data
```

```{r}
# Merge the dataframes on listing_id
merged_data <- merge(
  calendar_data_copy,
  listings_data_copy,
  by.x = "listing_id",
  by.y = "id"
)
```

```{r}
# Ensure data is properly formatted
merged_data$price_dollars <- as.numeric(gsub("[\\$,]", "", merged_data$price_dollars))
merged_data$date <- as.Date(merged_data$date, format="%Y/%m/%d")

# Extract year-month for grouping
merged_data <- merged_data %>%
  mutate(year_month = format(date, "%Y-%m"))

```

```{r}
merged_data
```


*** available_category חידוד בנוגע למשתנה :
- available_category = 0: הנכס הוצע על ידי המארח אבל לא הוזמן ע"י לקוח
- available_category = 1: הנכס הוצע על ידי המארח והוזמן ע"י לקוח
- תאריך שלא הופיע זה תאריך שלא הוצע ע" המארח

-----------------------------------------------------------------------

## 1. Growth

הגדרת המטריקה:

* Growth in New Airbnb Listings can be a crucial metric for understanding the expansion and market penetration of your Airbnb business. 
This metric tracks the increase in the number of new properties added to the platform over time, reflecting business growth and the attractiveness of the platform to hosts.

* The metric: Growth in New Listings

* Definition: Measures the rate at which new properties are being added to the Airbnb platform, indicating business expansion and market share growth.

* Formula:
  Growth in New Listings = ((Number of New Listings in this month - Number of New Listings last month) / Number of New Listings last month ) X 100

* Benefits:
  - Market Expansion: Shows how effectively the company is expanding its property portfolio, which is essential for increasing market presence and offering more options to travelers.
  - Host Acquisition Success: Indicates the success of marketing and recruitment efforts in attracting new hosts to the platform.
  - Competitive Advantage: Helps to assess the competitive position in the market; a high growth rate in listings can indicate a strong brand and attractive value proposition for hosts. 

* Business Conclusions and Recommendations
  - Identify Market Trends: Track where new listings are being added geographically to understand emerging popular areas. This can help tailor marketing strategies to target potential new hosts in these regions.

  - Assess Platform Attractiveness: A high rate of new listings growth suggests that the platform is appealing to hosts. Maintain and enhance this attractiveness through user-friendly interfaces, competitive fees, and support services.

  - Evaluate and Optimize Host Acquisition Strategies: If growth in new listings is slowing, it may indicate the need to re-evaluate host acquisition strategies. This could involve improving host incentives, marketing campaigns, or simplifying the listing process.

  - Resource Allocation: Use insights from new listings growth to allocate resources effectively, such as enhancing customer support in areas with rapid listing growth or increasing marketing efforts in regions with potential for new hosts.

  - Monitor Competition: Understand how your growth in new listings compares with competitors to gauge market positioning. A slower growth rate relative to competitors may necessitate strategic adjustments.


מה היא תופסת ומה מפספסת:
* What the Metric Captures:
  - Business Expansion: This metric effectively tracks the growth of Airbnb’s property portfolio, providing a clear indication of how the company is expanding in terms of available listings. It reflects the company's ability to attract new hosts and increase its market share.

  - Market Penetration: It provides insights into how well Airbnb is penetrating new markets or expanding in existing ones, which is crucial for understanding the geographic spread and reach of the business.

  - Platform Attractiveness: A high growth rate in new listings suggests that the platform is appealing to hosts, which could be due to favorable terms, a strong brand reputation, or effective marketing strategies.

  - Host Acquisition Effectiveness: This metric can be a good indicator of the success of host acquisition strategies, showing how many new hosts are joining the platform over time.


* What the Metric Misses:
  - Quality of Listings: The metric does not account for the quality of new listings being added. An increase in the number of listings does not necessarily translate to better guest experiences or higher revenues if the quality of the new properties is low.

  - Host Retention and Churn: This metric focuses on new listings and does not provide information on how many existing listings are leaving the platform. High churn rates could offset the benefits of acquiring new listings.

  - Revenue Contribution: It does not directly measure the revenue impact of new listings. Some new properties may generate little revenue due to low occupancy rates, poor location, or inadequate marketing.

  - Guest Demand: The growth in listings alone does not reflect the balance between supply (number of listings) and demand (guest bookings). A high growth rate in listings without corresponding growth in demand could lead to lower occupancy rates and revenue per available room (RevPAN).

  - Operational Costs: The metric does not account for the increased operational costs associated with managing a larger number of listings, which could impact overall profitability.

  - Seasonal Variations: It may not fully capture the impact of seasonal variations on new listing rates, which can fluctuate due to seasonal travel trends or economic conditions.

מדד:
```{r}
# Calculate the number of new listings per month
new_listings_per_month <- listings_data_copy %>%
  group_by(host_since_month) %>%
  summarise(new_listings = n())

# Calculate growth in new listings month-over-month
new_listings_per_month <- new_listings_per_month %>%
  mutate(
    growth_rate = (new_listings - lag(new_listings)) / lag(new_listings) * 100
  )
```

```{r}
new_listings_per_month 
```

```{r}
# Convert host_since_month back to Date for plotting
new_listings_per_month$host_since_month <- as.Date(paste0(new_listings_per_month$host_since_month, "-01"))
```


```{r echo=TRUE, fig.width=18, fig.height=12}
ggplot(new_listings_per_month, aes(x = host_since_month, y = new_listings)) +
  geom_line(color = "blue", size = 1) +
  geom_point(color = "blue", size = 2) +
  labs(title = "Number of New Listings per Month",
       x = "Month",
       y = "Number of New Listings") +
  scale_x_date(date_labels = "%b %Y", date_breaks = "1 month") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
```{r echo=TRUE, fig.width=18, fig.height=12}
# Plotting the growth rate in new listings
ggplot(new_listings_per_month, aes(x = host_since_month, y = growth_rate)) +
  geom_line(color = "green", size = 1) +
  geom_point(color = "green", size = 2) +
  labs(title = "Growth Rate in New Listings per Month",
       x = "Month",
       y = "Growth Rate (%)") +
  scale_x_date(date_labels = "%b %Y", date_breaks = "1 month") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

The plots illustrate the growth in new Airbnb listings over time, providing insights into the company's expansion and market dynamics:

* Number of New Listings per Month
- Trend Analysis: The first plot shows the absolute number of new listings added each month. There's a noticeable increase in new listings over time, indicating an expanding portfolio of properties. This growth suggests a positive trend in the company’s ability to attract new hosts, likely contributing to increased market share and revenue potential.
- Seasonal Fluctuations: The plot also reveals seasonal or periodic spikes in new listings, which could correlate with strategic marketing campaigns, seasonal travel patterns, or specific events that drive hosts to list their properties.

* Growth Rate in New Listings per Month
- Growth Rate Insights: The second plot depicts the growth rate of new listings, highlighting the percentage change month-over-month. The sharp spike early on could indicate a significant initial growth phase or response to an early market strategy.
- Stabilization: Following the initial spike, the growth rate stabilizes, which is common as markets mature. However, consistent positive growth rates suggest ongoing expansion and sustained interest from new hosts.
- Market Penetration: The fluctuations in growth rate also suggest varying levels of market penetration over time. Periods with higher growth rates could indicate successful outreach or market conditions favorable for new listings, while lower rates may suggest market saturation or external factors affecting growth.

* Overall Interpretation
- Business Expansion: The increase in both the number and growth rate of new listings over time indicates a robust expansion of Airbnb's property inventory. This expansion is crucial for meeting increasing demand and offering a diverse range of accommodations to guests.
- Strategic Adjustments: The observed patterns, especially the initial surge and subsequent stabilization, suggest that Airbnb may need to continuously adapt its strategies to maintain momentum. This could involve enhancing host engagement, optimizing listing quality, or expanding into new markets.
- Future Prospects: Sustained growth in new listings, even if at a slower rate, signals a healthy trajectory for the company. Ensuring that these new listings are high-quality and well-located will be essential for maintaining high occupancy rates and maximizing revenue.

These insights can help inform strategic decisions, such as where to focus marketing efforts, how to support hosts, and which markets may offer the best opportunities for further expansion.

דעה:
TODO


------------------------------------------------------------------



## 2. Growth by Neighborhood

הגדרת המטריקה:
TODO

* Monthly Revenue per Available Night (RevPAN) for Neighborhoods:

* Purpose:  To measure the efficiency of revenue generation in each neighborhood by analyzing the total revenue in relation to the number of available nights. 
  This helps identify which neighborhoods are performing well in terms of maximizing revenue from their available inventory.

* Concept: The metric considers the average performance of listings within each neighborhood, highlighting how effectively listings generate revenue on a per-night basis.

* עבור כל שכונה נסתכל על ההכנסות שהיא מביאה בכל חודש לעומת הלילות הפנויים בה בכל חודש


* The formula:

  Monthly Neighborhood RevPAN =  Total Revenue in Neighborhood / Total Available Nights in Neighborhood
  
  - Where:

    - Total Revenue in Neighborhood: The sum of all revenues generated by listings in a neighborhood for a given month (price_dollars of all the rows with available_category == 1).
    
    - Total Available Nights in Neighborhood: The total number of nights that listings were available (including both booked and unbooked nights) in the neighborhood for the same period.
  
* Why It's a Good Metric:

  - Comprehensive Performance Indicator: This metric provides a holistic view of how well listings in a neighborhood are monetizing their available nights. It combines the effects of pricing (ADR) and occupancy rates, giving a complete picture of revenue efficiency.

  - Insight into Demand and Pricing: By analyzing RevPAN, property managers can assess the effectiveness of their pricing strategies and understand how market demand affects different neighborhoods. High RevPAN suggests strong pricing power or high demand, while low RevPAN may indicate the need for price adjustments or promotional activities.

  - Operational Efficiency: RevPAN helps in understanding how well listings are being utilized. Neighborhoods with low RevPAN might be underperforming due to low occupancy or inadequate pricing strategies, signaling the need for operational adjustments.

  - Comparison Across Neighborhoods: This KPI allows for a standardized comparison of performance across different neighborhoods, regardless of the number of listings or their sizes. It normalizes revenue generation by accounting for availability, making it easier to identify which areas are most lucrative or need improvement.

  - Strategic Decision Making: Understanding which neighborhoods have higher RevPAN can guide investment decisions, such as where to focus marketing efforts or property improvements. It also aids in resource allocation, ensuring that efforts are directed toward the most profitable areas.
  
  
מה היא תופסת ומה מפספסת:
* Captures:

  - Revenue Efficiency: RevPAN (Revenue per Available Night) effectively captures how well listings are monetizing their availability in each neighborhood. It integrates the impact of pricing strategies (ADR) and occupancy rates, providing a comprehensive view of revenue efficiency.

  - Demand and Pricing Effectiveness: This metric highlights the relationship between demand and pricing. Higher RevPAN suggests that a neighborhood has strong demand or effective pricing strategies, while lower RevPAN may indicate areas where pricing or marketing could be improved.

  - Operational Utilization: RevPAN helps assess the utilization of listings. A high RevPAN indicates that listings are being used effectively, maximizing revenue from available nights, while low RevPAN suggests potential underutilization.



* Misses:

  - Cost Factors: RevPAN does not account for the costs associated with running or maintaining listings, such as cleaning, maintenance, or property management fees. It focuses solely on revenue, missing a complete picture of profitability.

  - Market Trends: While RevPAN provides insights into current performance, it does not directly capture broader market trends, such as seasonal demand fluctuations or competitive dynamics in different neighborhoods.

  - Guest Satisfaction and Ratings: This metric does not consider guest satisfaction, ratings, or reviews, which can significantly impact future bookings and revenue. Neighborhoods with high RevPAN might have low guest satisfaction, which could affect long-term growth.

  - Detailed Occupancy Insights: Although RevPAN includes occupancy as a factor, it does not provide detailed insights into specific patterns, such as length of stay, booking lead time, or cancellation rates, which are critical for nuanced understanding and strategic planning.

  - Variability in Listing Types: RevPAN aggregates data across all listings in a neighborhood, potentially obscuring differences in performance between various types of properties (e.g., luxury vs. budget accommodations). This can lead to generalized insights that may not apply equally across all listings.

מדד:

```{r}
# Calculate the metrics
neighborhood_revpan_data <- merged_data %>%
  group_by(neighbourhood, year_month) %>%
  summarise(
    total_revenue = sum(price_dollars[available_category == 1], na.rm = TRUE), # Sum of all revenues in the neighborhood for booked nights
    nights_booked = sum(available_category == 1),  # Count of booked nights
    total_nights = n(), # Count of all nights in the month for all listings
    RevPAN = total_revenue / total_nights, # Monthly RevPAN calculation
    occupancy_rate = nights_booked / total_nights, # Availability rate calculation
    .groups = "drop"
  )
```

```{r}
neighborhood_revpan_data
```

```{r}
label_data <- neighborhood_revpan_data %>%
  group_by(neighbourhood) %>%
  filter(year_month == max(year_month)) %>%
  ungroup()
```


```{r, echo=TRUE, fig.width=18, fig.height=12}
# Plotting Monthly RevPAN for each neighborhood
ggplot(neighborhood_revpan_data, aes(x = year_month, y = RevPAN, color = neighbourhood, group = neighbourhood)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  geom_text(data = label_data, aes(label = neighbourhood), hjust = 0, vjust = -0.5, size = 3, check_overlap = TRUE) +
  labs(title = "Monthly RevPAN by Neighborhood",
       x = "Month",
       y = "RevPAN (Revenue per Available Night)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.margin = margin(10, 40, 10, 10),
        legend.position = "right") +
  scale_color_discrete(name = "Neighborhood") +
  coord_cartesian(clip = "off")
```
The graph shows the Monthly Revenue per Available Night (RevPAN) across different neighborhoods over time. 
Each line represents a neighborhood, and the y-axis represents the RevPAN, while the x-axis represents the months.

* Observations:
  ** Variation Across Neighborhoods (שונות בין השכונות):
    There is a noticeable variation in RevPAN across different neighborhoods. 
    Some neighborhoods consistently have higher RevPAN, indicating they generate more revenue per available night on average.
  - Neighborhoods like Financial District and Beacon Hill show higher RevPAN, indicating they generate more revenue per available night compared to other areas.
  - In contrast, neighborhoods such as Roxbury and Dorchester often have lower RevPAN, suggesting less revenue efficiency.

** Trends Over Time:
  - The RevPAN values fluctuate over time for most neighborhoods. 
    Some neighborhoods show a sharp increase or decrease in certain months, while others remain relatively stable.
  - For example, Back Bay and South End show significant fluctuations in RevPAN over time, with noticeable peaks and troughs, 
    while neighborhoods like East Boston and Roslindale maintain more stable trends.

** High and Low Performing Areas:
  - Certain neighborhoods, such as the one with the highest peaks (likely representing high demand or high pricing), outperform others. 
  Conversely, some neighborhoods consistently have lower RevPAN, indicating less revenue efficiency.
  - Beacon Hill and Financial District consistently show high RevPAN, indicating strong demand or effective pricing strategies. 
    Conversely, Roxbury and Mattapan generally display lower RevPAN, highlighting challenges in generating revenue per available night.

** Consistency and Volatility:
  - Some neighborhoods demonstrate consistency in RevPAN, while others show volatility with significant ups and downs. 
  This volatility could be due to seasonal factors, special events, or changes in pricing strategy.
  - Neighborhoods such as North End show consistent performance, 
    whereas Chinatown and Leather District exhibit more volatility, 
    possibly due to varying demand or event-driven fluctuations.
    
    
* Business Insights:
** High-Performing Neighborhoods:
  - The neighborhoods with higher RevPAN may be areas of strong demand or those with higher listing quality. 
    These areas could be prioritized for investment or marketing to capitalize on their revenue potential.
  - Beacon Hill and Financial District are high-performing neighborhoods with strong demand. 
    These areas could benefit from targeted marketing and investment to further enhance their revenue potential.

** Underperforming Neighborhoods:
  - Neighborhoods with consistently low RevPAN might need targeted interventions. This could include adjusting pricing strategies, 
    improving listing quality, or increasing marketing efforts to boost visibility and attractiveness.
  - Roxbury and Dorchester are underperforming, with consistently low RevPAN. 
    Strategies such as price adjustments, property improvements, or increased marketing could help attract more guests and improve revenue.

** Seasonal and Temporal Trends:
  - The fluctuating trends suggest that RevPAN is influenced by seasonal factors. 
    Understanding these patterns can help in planning for peak and off-peak periods, optimizing pricing, and managing occupancy rates.
  - Fluctuations in neighborhoods like Back Bay and South End may be due to seasonal events or changes in demand. 
    Understanding these patterns can help in optimizing pricing and managing occupancy rates during different times of the year.

** Strategic Planning:
  - The data indicates areas where the business can focus to maximize revenue. 
    High-performing neighborhoods should be leveraged, while strategies should be developed to address the challenges in lower-performing areas.
  - The data suggests focusing on neighborhoods like Beacon Hill and Financial District for maximizing revenue while addressing challenges in Roxbury and Dorchester. 
    This approach ensures a balanced strategy that leverages high-performing areas and improves underperforming ones.


נסתכל גם על התפוסה בכל שכונה, זה יעזור לנו להבין עוד יותר טוב אם צריך להוריד מחיר בשכונות מסויימות כדי להעלות את התפוסה ולגרום לצמיחה בשכונה:

```{r, echo=TRUE, fig.width=18, fig.height=12}
# Plotting Monthly Occupancy Rate for each neighborhood
ggplot(neighborhood_revpan_data, aes(x = year_month, y = occupancy_rate * 100, color = neighbourhood, group = neighbourhood)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  geom_text(data = label_data, aes(label = neighbourhood), hjust = 0, vjust = -0.5, size = 3, check_overlap = TRUE) +
  labs(title = "Monthly Occupancy Rate by Neighborhood",
       x = "Month",
       y = "Occupancy Rate (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.title = element_blank())
```



* Growth Insights per Neighborhood:
** High Growth Neighborhoods:
```{r}
filtered_data <- neighborhood_revpan_data %>%
  filter(neighbourhood %in% c("Beacon Hill", "Financial District", "North End"))

# Plot the filtered data
ggplot(filtered_data, aes(x = year_month, y = RevPAN, color = neighbourhood)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  labs(title = "Monthly RevPAN for Beacon Hill, North End and Financial District",
       x = "Month",
       y = "RevPAN (Revenue per Available Night)",
       color = "Neighborhood") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylim(0, 300)  # Set the y-axis limits from 0 to 300 link in the original graph
```
```{r}
# Plotting Monthly Occupancy Rate for the selected neighborhoods
ggplot(filtered_data, aes(x = year_month, y = occupancy_rate * 100, color = neighbourhood, group = neighbourhood)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  labs(title = "Monthly Occupancy Rate for Beacon Hill, North End, and Financial District",
       x = "Month",
       y = "Occupancy Rate (%)",
       color = "Neighborhood") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylim(0, 100)
```
  - Beacon Hill, North End and Financial District show consistent growing RevPAN values, indicating strong growth in revenue generation per available night. 
    This suggests that these neighborhoods are either attracting more guests, maintaining high prices, or both, which is a positive indicator of growth.
    
  - Beacon Hill and North End exhibit relatively high and stable occupancy rates, further supporting their positive performance. 
    These areas are consistently attracting guests, likely due to favorable location, amenities, or pricing strategies that align well with market demand.

  - The Financial District, despite showing growth in RevPAN, has a lower and more variable occupancy rate. 
    This could indicate potential issues with guest attraction or retention. 
    There may be opportunities to increase occupancy through targeted marketing, special offers, or enhanced amenities to make the listings more appealing.

  - Overall, the combination of increasing RevPAN and stable occupancy in most areas points to a healthy and growing business in these neighborhoods. 
    However, addressing the variability in the Financial District's occupancy could unlock further growth potential, 
    maximizing revenue and ensuring consistent performance across all neighborhoods.

** Stable Neighborhoods:
```{r}
filtered_data <- neighborhood_revpan_data %>%
  filter(neighbourhood %in% c("Allston-Brighton", "Hyde Park", "Mission Hill"))

# Plot the filtered data
ggplot(filtered_data, aes(x = year_month, y = RevPAN, color = neighbourhood)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  labs(title = "Monthly RevPAN for Allston-Brighton, Hyde Park and Mission Hill",
       x = "Month",
       y = "RevPAN (Revenue per Available Night)",
       color = "Neighborhood") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylim(0, 300)  # Set the y-axis limits from 0 to 300 link in the original graph
```
```{r}
# Plotting Monthly Occupancy Rate for the selected neighborhoods
ggplot(filtered_data, aes(x = year_month, y = occupancy_rate * 100, color = neighbourhood, group = neighbourhood)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  labs(title = "Monthly Occupancy Rate for Allston-Brighton, Hyde Park and Mission Hill",
       x = "Month",
       y = "Occupancy Rate (%)",
       color = "Neighborhood") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylim(0, 100)
```

  - Allston-Brighton, Hyde Park, and Mission Hill: These neighborhoods show relatively stable RevPAN values over time, indicating consistent performance. This stability suggests that these areas have a steady demand and well-balanced pricing strategy, which helps maintain their revenue per available night.

  - Occupancy Rates: The occupancy rates in these neighborhoods are generally moderate, ranging from 20% to 50%. This indicates that while there is demand, there might be potential to increase occupancy through marketing efforts, special offers, or improving property features to attract more guests.

  - Price and Occupancy Strategy: Given the stability in RevPAN and moderate occupancy rates, these neighborhoods might benefit from a targeted strategy to either increase occupancy without lowering prices significantly or to slightly adjust prices to boost RevPAN. This could involve differentiating offerings or focusing on enhancing the guest experience to attract repeat bookings.

** Declining Neighborhoods:

```{r}
filtered_data <- neighborhood_revpan_data %>%
  filter(neighbourhood %in% c("Downtown", "Chinatown"))

# Plot the filtered data
ggplot(filtered_data, aes(x = year_month, y = RevPAN, color = neighbourhood)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  labs(title = "Monthly RevPAN for Downtown and Chinatown",
       x = "Month",
       y = "RevPAN (Revenue per Available Night)",
       color = "Neighborhood") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylim(0, 300)  # Set the y-axis limits from 0 to 300 link in the original graph
```


```{r}
# Plotting Monthly Occupancy Rate for the selected neighborhoods
ggplot(filtered_data, aes(x = year_month, y = occupancy_rate * 100, color = neighbourhood, group = neighbourhood)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  labs(title = "Monthly Occupancy Rate for Downtown and Chinatown",
       x = "Month",
       y = "Occupancy Rate (%)",
       color = "Neighborhood") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylim(0, 100)
```

  - The neighborhoods of Chinatown and Downtown show a clear pattern of declining RevPAN, starting with relatively high values and gradually decreasing over the observed period.        This trend indicates a reduction in revenue efficiency per available night, suggesting potential challenges in maintaining occupancy rates or pricing strategies.

  - The accompanying occupancy rate graph highlights that while both neighborhoods started with relatively high occupancy rates, there was a noticeable decline, 
    particularly in Chinatown. 
    This drop in occupancy, coupled with the declining RevPAN, suggests a decrease in guest interest or competitiveness of the listings, 
    possibly due to market saturation, pricing issues, or other external factors.
  
** Harvard Square:
```{r}
filtered_data <- neighborhood_revpan_data %>%
  filter(neighbourhood %in% c("Harvard Square"))

# Plot the filtered data
ggplot(filtered_data, aes(x = year_month, y = RevPAN, color = neighbourhood)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  labs(title = "Monthly RevPAN for Harvard Square",
       x = "Month",
       y = "RevPAN (Revenue per Available Night)",
       color = "Neighborhood") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylim(0, 300)  # Set the y-axis limits from 0 to 300 link in the original graph
```

```{r}
# Plotting Monthly Occupancy Rate for the selected neighborhoods
ggplot(filtered_data, aes(x = year_month, y = occupancy_rate * 100, color = neighbourhood, group = neighbourhood)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  labs(title = "Monthly Occupancy Rate for Downtown and Chinatown",
       x = "Month",
       y = "Occupancy Rate (%)",
       color = "Neighborhood") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylim(0, 100)
```
  - The RevPAN for Harvard Square shows a sharp decline from September 2016 to December 2016, with values starting relatively high and then dropping significantly. After December 2016, the RevPAN stabilizes at a lower level, indicating a marked reduction in revenue efficiency per available night. This trend suggests challenges in maintaining competitive pricing or occupancy rates, leading to a need for strategic adjustments in this neighborhood to improve performance. Additionally, the corresponding occupancy rate data reflects a similar trend, with an initial increase followed by a dramatic decline and sustained low levels, highlighting the urgent need for intervention to attract guests and boost revenue.

דעה:
TODO


------------------------------------------------------------------


## 3. Price Change

הגדרת המטריקה:
מטריקה המראה את ההכנסה ההמוצעת ללילה (תאריך) זמין עך ידי המארח עבור כל נכס.
הוא מספק תובנות לגבי האפקטיביות של אסטרטגיית התמחור של הנכס וביצועי ההכנסות הכוללים שלו.

* RevPAN measures the average revenue generated per night that a listing is available for booking, calculated monthly. It combines the effects of pricing strategies (Average Daily Rate, ADR) and booking success (Occupancy Rate), offering a comprehensive view of how effectively a listing utilizes its availability to generate income.

* RevPAN per listing assesses the revenue efficiency by indicating the revenue generated per available night on average. This metric is crucial for understanding the balance between setting competitive prices and achieving high occupancy rates, enabling property managers and hosts to optimize their strategies to maximize income.

Also read here:
- https://airbtics.com/revpan/ -> הכי מדוייק לנו
- https://help.usewheelhouse.com/en/articles/1817194-understanding-the-revenue-per-available-night-chart
- https://www.lake.com/help/glossary/revenue-per-available-night/
- https://roompricegenie.com/revpar-what-is-revpar/
- https://lodgable.com/airbnb-kpis/
- https://hostify.com/blog/key-airbnb-performance-metrics-hosts-should-track
- https://www.airdna.co/blog/vacation-rental-metrics-revpar

* The formula:

  1. RevPAN = ADR × Occupancy Rate per month

  Where:
  - ADR (Average Daily Rate) = Total listing Revenue / # Nights Booked
  - Occupancy Rate = # Nights Booked / # All Nights per listing
  
  ** # Nights Booked = # nights where the listing was rented out aka where available_category = 1
  
  ** Total Listing Revenue = sum of price_dollars for a listing where available_category = 1 (indicating the room was available and booked).
  
  ** # All Nights per Listing = both booked and unbooked nights within the month.
  
  ** Average Daily Rate (ADR): This is how much a host charges per day for their rental,
  reflecting the pricing strategy of the property.
  
  ** Occupancy Rates: This metric shows the percentage of available rooms or rentals occupied at a given time. 
  It helps property managers understand the demand and attractiveness of their property.
  
  or
  
  2. RevPAN = Total listing Revenue / # All Nights per listing  
  
  This formula directly calculates RevPAN by dividing the total revenue by the total number of available nights for the listing in a given month.

* רוב הנכסים עם מספר זהה יחסית של לילות (המכנה) ->חשוב להראות את זה

* אפשר לחשוב על מדד זה כעל פוטנציאל רווח עבור כל נכס:
  - איך נתרגם מטריקה זו לצמיחה?
  עבור הנכסים עם פוטנציאל נמוך נצטרך לחשוב או לבנות אסטרטגיה לצורך העלאת הרווח.
  
  1. עבור תפוסה נמוכה - נוריד מחיר 
    נרצה להעלות את פוטנציאל הנכס, 
    הרי התפוסה שלו נמוכה אז כנראה בעל הנכס מבקש עבורו מחיר גבוה מידיי. 
    נמליץ לו להוריד מעט את המחיר על מנת למשוך יותר לקוחות.
    
  2. עבור תפוסה מלאה - נעלה מחיר 
    נרצה להעלות את פוטנציאל הנכס,
    הרי התפוסה מלאה כלומר אנשים אוהבים את הנכס אבל אין פוטנציאל הרווח שלו לא ממומש.
    נמליץ לבעל הנכס להעלות את המחיר וכך ירוויח יותר.
    
*  חשוב- כאן נעשה את המדד עבור כל חודש של ליסטינג, כל נכס מקבל ציון מהמדד עבור כל חודש.


מה היא תופסת ומה מפספסת:

* Captures:

  - Revenue Efficiency: RevPAN effectively captures how efficiently listings generate revenue from their available nights, providing a clear metric for understanding income generation relative to availability.

  - Pricing Strategy Effectiveness: By incorporating the Average Daily Rate (ADR), RevPAN reflects the effectiveness of pricing strategies in maximizing revenue per available night.

  - Occupancy and Demand: The Occupancy Rate component of RevPAN highlights how well listings are utilized, indicating the level of demand and the attractiveness of the property or neighborhood.

  - Comparability Across Listings: This metric standardizes revenue data across different listings and neighborhoods, making it easier to compare performance despite variations in property size, type, or price range.



* Misses:

  - Cost Considerations: RevPAN focuses solely on revenue, omitting any cost factors such as maintenance, utilities, management fees, or other expenses associated with running a listing. This limitation means that RevPAN does not provide insights into the actual profitability of listings.

  - Seasonal and Market Trends: While RevPAN reflects current revenue performance, it does not inherently account for broader market trends, such as seasonal variations or economic conditions that can impact demand and pricing strategies.

  - Guest Satisfaction and Quality Metrics: The metric does not capture guest satisfaction, quality of service, or review ratings, which are critical factors in long-term success and repeat bookings.

  - Detailed Occupancy Patterns: RevPAN provides a broad measure of occupancy but lacks granularity regarding specific occupancy patterns, such as average length of stay, booking lead times, or cancellation rates, which can provide deeper insights into booking behaviors and trends.

  - Contextual Factors: RevPAN does not consider external factors that might influence performance, such as new competition, changes in local regulations, or events that temporarily affect booking patterns.

  - Differentiation in Property Types: While useful for general comparisons, RevPAN may not adequately differentiate between various property types (e.g., luxury vs. budget accommodations), potentially leading to less targeted insights for specific segments of the market.
  
  
  

מדד:

```{r}
# Calculate RevPAN per listing per month
revpan_data <- merged_data %>%
  group_by(listing_id, year_month) %>%
  summarise(
    total_revenue = sum(price_dollars[available_category == 1], na.rm = TRUE),  # Revenue from booked nights
    nights_booked = sum(available_category == 1),  # Count of booked nights
    total_nights = n(),  # Total nights in the data for the listing/month
    ADR = ifelse(nights_booked > 0, total_revenue / nights_booked, 0),  # Avoid division by zero
    occupancy_rate = ifelse(total_nights > 0, nights_booked / total_nights, 0),  # Avoid division by zero
    RevPAN = ifelse(total_nights > 0, total_revenue / total_nights, 0),  # Avoid division by zero
    .groups = "drop"
  )
```


```{r}
# Display the results
revpan_data
```

```{r}
# Sample 5 random listings
set.seed(123)  # For reproducibility
random_listings <- sample(unique(revpan_data$listing_id), 5)
random_listings
```


```{r}
# Filter data for these listings
plot_data <- revpan_data %>% filter(listing_id %in% random_listings)

# Plot
ggplot(plot_data, aes(x = year_month, y = RevPAN, group = listing_id, color = factor(listing_id))) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  labs(title = "RevPAN Over Time for Random Listings",
       x = "Month",
       y = "RevPAN (Revenue per Available Night)",
       color = "Listing ID") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
לא ממש אומר משהו..

```{r}
# Summarize RevPAN data by month
revpan_summary <- revpan_data %>%
  group_by(year_month) %>%
  summarise(avg_revpan = mean(RevPAN, na.rm = TRUE))

# Plot RevPAN over time
ggplot(revpan_summary, aes(x = year_month, y = avg_revpan)) +
  geom_line(color = "blue", size = 1) +
  geom_point(color = "red", size = 2) +
  labs(title = "Monthly RevPAN Trend",
       x = "Month",
       y = "Average RevPAN (Revenue per Available Night)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
- This is a visual representation of the RevPAN (Revenue per Available Night) over time, averaged across all listings.
- This visualization helps in identifying trends, seasonal patterns, and potential impacts of external factors on revenue efficiency.


*Observations:

  - Initial Decline: The graph shows a significant decline in RevPAN from September 2016 to February 2017. This could indicate a decrease in revenue generated per available night, possibly due to lower booking rates, reduced prices, or both.
    
  - Recovery Period: From February 2017 to June 2017, there is a recovery trend in RevPAN, suggesting an increase in bookings, higher prices, or both. This improvement indicates positive adjustments in the business strategy, such as pricing or marketing efforts.
  
  - Stabilization: Post-June 2017, the RevPAN appears to stabilize, indicating that the pricing and occupancy rates may have reached a more consistent state. This stability is beneficial for predictable revenue streams.
  
  

* Business Insights:

  - State of the Business: The business experienced fluctuations in revenue efficiency, with a notable dip in early 2017. The recovery and subsequent stabilization are positive signs, suggesting effective responses to market conditions or improvements in service offerings.
    
  - Price Change: The metric highlights significant price changes or occupancy variations. The initial dip could indicate a decrease in average prices, a drop in occupancy rates, or both. The recovery phase suggests improvements in these areas, possibly through pricing adjustments, enhanced property quality, or increased demand.



* Considerations and Limitations:

  - Metric Definition: While RevPAN provides valuable insights into revenue efficiency, it doesn't capture all aspects of business health. For example, it does not account for operational costs, marketing expenditures, or other factors that might impact profitability.
    
  - Data Quality: The current analysis relies on available data, which may not include all factors influencing RevPAN. Additional data on marketing campaigns, guest reviews, and competitive pricing could provide a more comprehensive understanding.
    
  - Richer Data: Incorporating data on occupancy rates by room type, guest demographics, and seasonal trends could enhance the accuracy of RevPAN calculations. This would help in identifying more precise factors influencing revenue changes and enable better strategic planning.



This analysis suggests that while RevPAN offers a useful snapshot of revenue per available night, further data and analysis are necessary to fully understand the drivers of business performance and to make informed decisions for future growth.


* if we will look on the Occupancy Rate graph per month we can say that in months with the low RevPAN we need either to increase the price or decrease the price to occupancy percentages.

```{r}
# Calculate average occupancy rate per month and convert to percentage
monthly_avg_occupancy <- revpan_data %>%
  group_by(year_month) %>%
  summarise(avg_occupancy_rate_percentage = mean(occupancy_rate * 100, na.rm = TRUE))

# Plotting Occupancy Rate per Month
ggplot(monthly_avg_occupancy, aes(x = year_month, y = avg_occupancy_rate_percentage)) +
  geom_line(color = "blue", size = 1) +
  geom_point(color = "blue", size = 2) +
  labs(title = "Monthly Occupancy Rate",
       x = "Month",
       y = "Occupancy Rate (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

* From the two graphs:
  
  1. RevPAN Trend: This shows fluctuations in revenue per available night over the months.
  2. Occupancy Rate: This displays the percentage of occupied nights compared to available nights.


* Analysis:
  - Months with High Occupancy but Low RevPAN: If a month shows a high occupancy rate but a low RevPAN, it suggests that rooms are fully booked, but the prices might be too low. 
  Increasing the price in these months could help boost revenue without significantly affecting occupancy, as demand is strong. 
  
    For instance, look at December 2016 and January 2017, where the occupancy rate was high, but there was a decline in RevPAN. 
    This indicates that while many rooms were booked, the income per night wasn't as high as it could be, possibly due to lower pricing.
  
  - Months with Low Occupancy and Low RevPAN: If both occupancy and RevPAN are low, it suggests that both demand and pricing are issues. 
    In such cases, decreasing the price might attract more bookings, thus increasing the occupancy rate and potentially the overall revenue. 
  
    For example, September 2016 show drops in both occupancy rate and RevPAN. 
    In these cases, lowering prices might make the listings more attractive to potential guests, leading to increased bookings and occupancy.
  
  - Months with High RevPAN but Low Occupancy: Though not clearly evident in these graphs, if such a scenario occurs, it indicates high prices but low demand. 
    A price reduction might help increase the occupancy rate, possibly leading to more stable and higher overall revenue.


* Conclusion: 
  - Increase Prices: Consider increasing prices during high occupancy months like December and January to maximize revenue, provided that the increase does not significantly deter bookings.
  - Adjust Prices: Evaluate the pricing strategy during low occupancy months to find a balance between attracting more guests and maintaining reasonable revenue per night.

דעה:
TODO

------------------------------------------------------------------




# Part 3 - Outliers

The first part is to identify a period of time in which the behavior is abnormal.

מה שאפשר לעשות זה גרף עם אחוזי תפוסה לכל יום:
ציר האיקס - ימים
ציר הווי - אחוזי תפוסה פר תאריך

לאחר מכן, נוכל להבין אם יש טווחי זמן שהם מוזרים: אחוזי תפוסה גבוהים או נמוכים מהרגיל ולפי זה נדע להתמקד על התקופת זמן ולהבין מה קורה שם, אולי זאת תקופת חגים.

Our interpretation of the data is that:
available_category = 0 is when the listing was listed but was not booked
available_category = 1 is when the listing was listed and was booked
no date for a listing is when the listing was not listed at that day

Let's look at the time frame of the data provided:

```{r}
#TODO

pacman::p_load(lubridate, visdat, data.table)

print("Hi")

md <- as.data.table(merged_data)
md <- md[, listing_id, date]
md <- md[order(date)]
md <- md[, .N, by=date]
md

```

```{r}
# fwrite(md, "md.csv")
ggplot(md) +
  aes(x = date, y = N) +
  geom_point() +
  scale_x_date(
    limits = c(min(md$date),NA),
    breaks = seq(min(md$date), max(md$date)+1, by = "2 months"),
    labels = date_format("%Y-%d-%m")
               )
```

```{r}


ggplot(md) +
  aes(x = date, y = N) +
  geom_bar(stat = "summary", fun = "sum", fill = "#112446") +
  theme_minimal() + 
  scale_x_date(
    limits = c(min(md$date),NA),
    breaks = seq(min(md$date), max(md$date)+1, by = "2 months"),
    labels = date_format("%Y-%m-%d")
               )  +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


As we can see, all the data is spread across a one year time frame:
from 6-9-2016 to 6-9-2017


```{r}
calendar <- as.data.table(calendar_data)
calendar <- calendar[order(date)]
calendar <- calendar[, .N, by=.(date, available_category)]

calendar[available_category == 1,.(date, N, available_category='1')]

ggplot(calendar[available_category == 1,.(date, N, available_category=1)]) +
  aes(x = date, y = N) + 
  geom_bar(stat = "identity", fun = "sum", fill = "#EF562D") +
  theme_minimal() +
  scale_x_date(
    limits = c(min(calendar$date),NA),
    breaks = seq(min(md$date), max(md$date)+1, by = "2 months"),
    labels = date_format("%Y-%m-%d")
               )
```

TODO - explain findings - from september...


```{r}
ggplot(calendar[available_category == 0,.(date, N, available_category=1)]) +
  aes(x = date, y = N) + 
  geom_bar(stat = "identity", fun = "sum", fill = "#EF562D") +
  theme_minimal() +
  scale_x_date(
    limits = c(min(calendar$date),NA),
    breaks = seq(min(md$date), max(md$date)+1, by = "2 months"),
    labels = date_format("%Y-%m-%d")
               )
```

```{r}
excluded_dates <- md[date >= min(md$date) & date <= max(md$date), date]
# Remove rows from the data.table where the date_col is in the excluded_dates
filtered_dt <- md[!(date %in% excluded_dates)]
filtered_dt
```

```{r}
# calendar <- as.data.table(calendar_data)
# calendar <- calendar[order(date)]
# calendar
# 
# # Change values with $ to a number in price_dollar
# calendar[available_category == 1, price_dollars := as.numeric(gsub("\\$", "", price_dollars))]
# anyNA(calendar[available_category == 1, price_dollars])
# 
# # Mean price
# mean(calendar$price_dollars, na.rm = TRUE)
# 
# mean(calendar[available_category == 1& !is.na(price_dollars), price_dollars])
# 
# # Mean price by date
# cat_prices <- calendar[available_category == 1& !is.na(price_dollars), 
#          .(mean_of_price_by_date = mean(price_dollars)), 
#          by = date]
# 
# 
# ggplot(cat_prices) +
#   aes(x = date, y = mean_of_price_by_date) + 
#   geom_bar(stat = "identity", fun = "sum", fill = "#EF562D") +
#   # theme_minimal() +
#   scale_x_date(
#     limits = c(min(calendar$date),NA),
#     breaks = seq(min(md$date), max(md$date)+1, by = "1 months"),
#     labels = date_format("%Y-%m-%d")
#                ) +
#   scale_y_continuous(
#     breaks = seq(0, max(cat_prices$mean_of_price_by_date, na.rm = TRUE), by = 10)
#   ) +
#   geom_hline(yintercept = seq(0, max(cat_prices$mean_of_price_by_date, na.rm = TRUE), by = 50), 
#              linetype = "dashed", color = "blue") +
#   theme(axis.text.x = element_text(angle = 60, hjust = 1))
```

```{r}
# Calculate occupancy rate per day
daily_occupancy <- merged_data %>%
  group_by(date) %>%
  summarise(
    total_listings = n(),  # Total listings on this day
    bookings = sum(available_category == 1, na.rm = TRUE),  # Listings booked on this day
    occupancy_rate = (bookings / total_listings) * 100  # Occupancy percentage
  )
```

```{r}
daily_occupancy
```


```{r}
# Plotting the daily occupancy rate
ggplot(daily_occupancy, aes(x = date, y = occupancy_rate)) +
  geom_line(color = "blue", size = 1) +
  geom_point(color = "blue", size = 1) +
  labs(title = "Daily Occupancy Rate",
       x = "Date",
       y = "Occupancy Rate (%)") +
  ylim(0, 100) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
אחוזי תפוסה, מה יכול להשפיע:
1. מחיר
2. יותר או פחות אנשים לנים
3. יותר נכסים הצטרפו לפלטפורמה


* Observations:
  - Initial Growth Period (Sept 2016 - Jan 2017):
    There is a noticeable increase in the occupancy rate from September 2016 to early January 2017. This trend suggests a growing demand for Airbnb listings or an increase in bookings during this period.

  - Stabilization Phase (Jan 2017 - Mar 2017):
    After reaching a peak in January 2017, the occupancy rate stabilizes around 60%. This could indicate a balance between supply and demand, where the number of available listings is meeting the booking demand consistently.
  
  - Decline and Fluctuations (Apr 2017 - Jul 2017):
    A sharp drop in the occupancy rate is observed around April 2017, followed by a period of lower and more stable occupancy rates. This decline might be due to seasonal factors, changes in the market, or a sudden increase in the number of listings (supply) without a proportional increase in bookings (demand).
  
  - Low Variation in Later Periods:
    After the initial fluctuations, the occupancy rate seems to stabilize around 50%. This steady rate indicates a potentially saturated market where the number of bookings is consistently matched by the number of available listings.
    
    
* Insights:
  - Seasonality and Demand Trends: The graph suggests that there might be seasonal trends in bookings, with higher occupancy rates observed towards the end of the year (potentially due to holiday travel) and a decline at the beginning of the year. Analyzing this further could help in understanding peak booking periods and optimizing pricing and availability.

  - Market Saturation or Increased Supply: The stabilization of occupancy rates at around 50% could indicate market saturation or an increase in the supply of listings. If the number of listings grows faster than the demand, occupancy rates will naturally decline. This information can be critical for strategic planning, such as focusing on marketing to increase bookings or improving listing quality to stand out.

  - Unusual Patterns or Anomalies: The sharp decline and subsequent stabilization in April 2017 could be due to specific events or changes in market conditions. Further investigation into external factors (like local events, economic changes, or policy shifts) during this period could provide more context.


* Strange Patterns:
  The sharp drop in occupancy rates around April 2017 stands out as unusual. Such a drastic change over a short period suggests an anomaly that warrants further investigation. This could be due to:
    - Market Over-saturation: A sudden influx of new listings that outpaced demand.
    - External Events: Possible external factors like new regulations affecting Airbnb listings, seasonal changes, or macroeconomic shifts.
    - Data Inconsistencies: Potential issues with data collection or reporting that need to be verified.

-----------------------------------

There is an abnormal drop in the daily occupancy rate is observed around early April 2017. This sudden decline in occupancy rates is unusual compared to the periods before and after this time.

```{r}
# Create a graph focusing on the abnormal period
ggplot(daily_occupancy, aes(x = date, y = occupancy_rate)) +
  geom_line(color = "blue", size = 1) +
  geom_point(color = "blue", size = 1) +
  labs(title = "Daily Occupancy Rate (Highlighting Abnormal Period)",
       x = "Date",
       y = "Occupancy Rate (%)") +
  scale_x_date(date_labels = "%b %Y", date_breaks = "1 month") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylim(0, 100) +
  annotate("rect", xmin = as.Date("2017-04-01"), xmax = as.Date("2017-04-30"),
           ymin = 0, ymax = 100, alpha = 0.2, fill = "red") +
  annotate("text", x = as.Date("2017-04-15"), y = 80, label = "Abnormal Drop", color = "red", size = 4) + 
    annotate("rect", xmin = as.Date("2016-09-01"), xmax = as.Date("2016-12-1"),
           ymin = 0, ymax = 100, alpha = 0.2, fill = "green") +
  annotate("text", x = as.Date("2016-10-15"), y = 80, label = "Increase in Occupancy", color = "darkgreen", size = 4)

```
אלו דברים פוטנציאליים שעשויים לגרום להתנהגות ה"לא נורמלית" הזו
(אבל זה לא בטוח צריך לבדוק)
* Potential Causes for Abnormal Values
  - Data Entry Error: It's possible that the data entry during this period contained errors, such as incorrect recording of available or booked nights. This could happen due to manual entry mistakes or system errors. (שגיאה בהזנת הנתונים)
  - Real-World Events: An unusual event in reality, such as a sudden influx of new listings, a major local event affecting bookings, or changes in regulations that impact Airbnb operations, could cause such a drop. (מקרה אמיתי)
  - Market Dynamics: An external factor such as a significant price increase or economic downturn might have led to fewer bookings, hence the lower occupancy rate. (דינמיקת שוק)


בואו נסתכל על המחיר הממוצע לנכס בכל יום ונבדוק האם הייתה קפיצה במחירים שגרמה לזה

```{r}
# Calculate the average price per day
average_price_per_day <- merged_data %>%
  group_by(date) %>%
  summarise(average_price = mean(price_dollars, na.rm = TRUE))
```


```{r}
# Plotting the average price per day
ggplot(average_price_per_day, aes(x = date, y = average_price)) +
  geom_line(color = "green", size = 1) +
  geom_point(color = "green", size = 1) +
  labs(title = "Daily Average Price",
       x = "Date",
       y = "Average Price ($)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylim(0, max(average_price_per_day$average_price, na.rm = TRUE) * 1.1)  # Extend y-axis slightly

```
```{r}
# Plotting the daily average price with full annotation
ggplot(average_price_per_day, aes(x = date, y = average_price)) +
  geom_line(color = "green", size = 1) +
  geom_point(color = "green", size = 1) +
  labs(title = "Daily Average Price",
       x = "Date",
       y = "Average Price ($)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylim(0, max(average_price_per_day$average_price, na.rm = TRUE) * 1.1) +  # Extend y-axis slightly
  annotate("rect", xmin = as.Date("2017-04-01"), xmax = as.Date("2017-04-30"),
           ymin = 0, ymax = max(average_price_per_day$average_price, na.rm = TRUE) * 1.1, alpha = 0.2, fill = "red") +
  annotate("text", x = as.Date("2017-04-15"), y = max(average_price_per_day$average_price, na.rm = TRUE), 
           label = "Jump in prices", color = "red", size = 4) +
    annotate("rect", xmin = as.Date("2016-09-01"), xmax = as.Date("2016-12-1"),
           ymin = 0, ymax = max(average_price_per_day$average_price, na.rm = TRUE) * 1.1, alpha = 0.2, fill = "green") +
  annotate("text", x = as.Date("2016-10-15"), y = max(average_price_per_day$average_price, na.rm = TRUE) * 0.8, 
           label = "Price drop", color = "darkgreen", size = 4)

```

התקופה המודגשת באדום: אפריל 2017
בגרף המחיר הממוצע היומי, ניכר זינוק במחירים בסביבות אפריל 2017, המתיישר עם ירידה חריגה שנצפתה בשיעור התפוסה המוצג בגרף שיעור התפוסה היומי. זה מצביע על מתאם ישיר שבו העלייה במחירים הובילה לירידה במספר ההזמנות. מחירים גבוהים יותר יכולים להרתיע שוכרים פוטנציאליים, במיוחד אם הם עוברים את הערך הנתפס או את סף הנגישות של השוק. זה מצביע על כך שעליית המחירים בתקופה זו ככל הנראה השפיעה לרעה על התפוסה, והדגישה את החשיבות של איזון אסטרטגיות תמחור לשמירה על רמות התפוסה.

התקופה המודגשת בירוק: ספטמבר עד דצמבר 2016
בגרף שיעור התפוסה היומי, אנו רואים עלייה עקבית בתפוסה מספטמבר עד דצמבר 2016, במקביל לירידה הדרגתית במחירים הממוצעים כפי שמתואר בגרף המחיר הממוצע היומי. תקופה זו מעידה על תגובה חיובית בשוק להורדת המחירים, וכתוצאה מכך שיעורי תפוסה גבוהים יותר. ייתכן שהמחירים הנמוכים יותר הפכו את הנכסים לאטרקטיביים יותר עבור שוכרים, מה שהוביל להגדלת ההזמנות. מגמה זו מעידה על גמישות הביקוש בשוק, בו התפוסה רגישה לשינויים במחיר.

אבללל נזכור שממוצע תעריף לילה לא ממש יכול לומר הרבה או לייצג באופן גורף כי יכול להיות שיש מחיר אחד שהקפיץ את הממוצע וכל השאר נורמלי (במרכאות)


נבדוק ערכים חסרים

```{r}
summary(merged_data)
skim(merged_data)
```

```{r}
# Count the number of NA values in price_dollars where available_category == 1
na_count <- sum(is.na(merged_data$price_dollars[merged_data$available_category == 1]))
na_count
```
כל הדירות שנחשבות לזמינות בעלות מחיר כלשהו

נסתכל על מחירי הנכסים, ננסה להזהות ערכים קיצוניים:

```{r}
# Identifying outliers in the data
boxplot(merged_data$price_dollars, main = "Boxplot of Listing Prices", ylab = "Price ($)")
```
נחלק ל 3 קבוצות:
Low Price: Listings with prices below the 25th percentile.
Medium Price: Listings with prices between the 25th and 75th percentiles.
Expensive: Listings with prices above the 75th percentile.

```{r}
# Calculate the quantiles for the price groups
quantiles <- quantile(merged_data$price_dollars, probs = c(0.25, 0.75), na.rm = TRUE)
low_price_threshold <- quantiles[1]
medium_price_threshold <- quantiles[2]

# Categorize the listings into price groups
merged_data <- merged_data %>%
  mutate(price_group = case_when(
    price_dollars <= low_price_threshold ~ "Low Price",
    price_dollars > low_price_threshold & price_dollars <= medium_price_threshold ~ "Medium Price",
    price_dollars > medium_price_threshold ~ "Expensive"
  ))

# Display the first few rows with the new price group column
head(merged_data)
```


```{r}
# Boxplot of Listing Prices by Price Group
ggplot(merged_data, aes(x = price_group, y = price_dollars, fill = price_group)) +
  geom_boxplot() +
  labs(title = "Boxplot of Listing Prices by Group",
       x = "Price Group",
       y = "Price ($)") +
  theme_minimal()
```

נשתמש בחולקה הזו של הנכסים לראות את המצב בכל חודש. 

```{r}
# Filter the data to include only the rented properties
rented_properties <- merged_data %>% filter(available_category == 1)

# Add a month-year column for aggregation
rented_properties <- rented_properties %>%
  mutate(month_year = floor_date(date, "month"))

# Calculate the percentage of properties rented in each price group for each month
monthly_price_group_percentage <- rented_properties %>%
  group_by(month_year, price_group) %>%
  summarise(count = n()) %>%
  group_by(month_year) %>%
  mutate(total_count = sum(count),
         percentage = (count / total_count) * 100)

# Plot the percentage of properties rented in each price group for each month
ggplot(monthly_price_group_percentage, aes(x = month_year, y = percentage, fill = price_group)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_x_date(date_labels = "%b %Y", date_breaks = "1 month") +
  labs(title = "Percentage of Properties Rented by Price Group Each Month",
       x = "Month-Year",
       y = "Percentage of Properties Rented",
       fill = "Price Group") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
נסתכל על שנת 2017:

```{r}
# Filter the data to include only the rented properties
rented_properties <- merged_data %>% filter(available_category == 1)

# Add a month-year column for aggregation
rented_properties <- rented_properties %>%
  mutate(month_year = floor_date(date, "month"))

# Filter for the year 2017
rented_properties_2017 <- rented_properties %>% 
  filter(year(month_year) == 2017)

# Calculate the percentage of properties rented in each price group for each month
monthly_price_group_percentage_2017 <- rented_properties_2017 %>%
  group_by(month_year, price_group) %>%
  summarise(count = n()) %>%
  group_by(month_year) %>%
  mutate(total_count = sum(count),
         percentage = (count / total_count) * 100)

# Plot the percentage of properties rented in each price group for each month
ggplot(monthly_price_group_percentage_2017, aes(x = month_year, y = percentage, fill = price_group)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_x_date(date_labels = "%b %Y", date_breaks = "1 month") +
  geom_text(aes(label = paste0(round(percentage, 1), "%")), 
            position = position_stack(vjust = 0.5), size = 3) +
  labs(title = "Percentage of Properties Rented by Price Group Each Month in 2017",
       x = "Month-Year",
       y = "Percentage of Properties Rented",
       fill = "Price Group") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
בחודש אפריל נמכרו הנכסים הכי יקרים מבין החודשים ב 2017
אבל זה לא ממש אומר הרבה כי זה רואים התנהגות יחסית דומה 


Occupancy and Price Relationship:
Investigate if the price increase correlates with occupancy rates. Higher occupancy rates may indicate higher demand, which could drive up prices.

נבדוק האם יש קשר בין אחוזי תפוסה לבין ממוצע תעריף יומי לילה. שיעורי תפוסה גבוהים עשויים להצביע על ביקוש גבוה יותר, מה שעלול להעלות את המחירים

זה לר גרף כלכך טוב :(

```{r}
# Calculating daily occupancy rate and average price
daily_analysis <- merged_data %>%
  group_by(date) %>%
  summarize(
    average_price = mean(price_dollars, na.rm = TRUE),
    occupancy_rate = sum(available_category == 1) / n()
  )

# Plotting occupancy rate vs average price
ggplot(daily_analysis, aes(x = occupancy_rate, y = average_price)) +
  geom_point(color = "purple") +
  geom_smooth(method = "lm", color = "red") +
  labs(title = "Occupancy Rate vs Average Price", x = "Occupancy Rate", y = "Average Price ($)")

```
נסתכל על ההפרשים בין המחיר הקטלוג לבין המחיר בפועל

```{r}
# Calculate the differences between org_price and price_dollars for each day
merged_data$price_difference <- merged_data$org_price - merged_data$price_dollars

# Create a line plot to visualize the differences over time with monthly x-axis labels
ggplot(merged_data, aes(x = date, y = price_difference)) +
  geom_line(color = "blue", size = 1) +
  geom_point(color = "blue", size = 1) +
  labs(title = "Differences Between Original Price and Actual Price in Dollars",
       x = "Date",
       y = "Price Difference ($)") +
  scale_x_date(date_labels = "%b %Y", date_breaks = "1 month") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
יש פה משהו מוזר, אבל קשה להבין את זה 
ננסה להסתכל על ההפרש הממוצע ליום
ושוב נקח בחשבון שמדובר על ממוצע וזה נותן אינטואציה ולא אומר משהו בוודאות

```{r}
# Calculate the differences between org_price and price_dollars for each day
merged_data$price_difference <- merged_data$org_price - merged_data$price_dollars

# Calculate the average price difference per day
average_price_difference_per_day <- merged_data %>%
  group_by(date) %>%
  summarise(avg_price_difference = mean(price_difference, na.rm = TRUE))

# Create a line plot to visualize the average price difference over time with monthly x-axis labels
ggplot(average_price_difference_per_day, aes(x = date, y = avg_price_difference)) +
  geom_line(color = "blue", size = 1) +
  geom_point(color = "blue", size = 1) +
  labs(title = "Average Differences Between Original Price and Actual Price in Dollars",
       x = "Date",
       y = "Average Price Difference ($)") +
  scale_x_date(date_labels = "%b %Y", date_breaks = "1 month") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
בממוצע בלבד! זה נראה שהמארחים לא דרשו פחות כסף ממה שהציגו לראשונה באתר כי כל התוצאות שליליות מה שאומר שהמחירים בפועל היו תמיד גבוהים מהמחיר הראשוני שאיתו נרשמו לפלטפורמה.

באפריל 2017 ניכרת צניחה שבה פער המחירים הממוצע הופך לשלילי יותר בהשוואה לחודשים אחרים באותה השנה.

זה מצביע על כך שבמהלך תקופה זו, המחירים בפועל היו גבוהים משמעותית מהמחירים המקוריים, מה שמרמז על כך שהמארחים עלולים להעלות את מחיריהם באופן משמעותי

עליית מחירים זו עשויה להיות מתואמת עם אירועים או גורמים ספציפיים לאותה תקופה, כגון ביקוש גבוה עקב חגים כמו חופשת האביב או אירועים מקומיים אחרים.

לפני ואחרי אפריל 2017, פערי המחירים פחות שליליים, מה שמעיד על כך שהמחירים בפועל היו קרובים יותר או אפילו נמוכים יותר מהמחירים המקוריים.

סה"כ זה נראה מ-2 הגרפים הקודמים שיש בימים בין חודש אפריל ומאי של 2017 הבדל קיצוני בין המחיר קטלוג למחיר ששולם בפועל לעומת שאר החודשים באותה השנה.
נראה כי המחיר ששולם בפועל גבוה מהקיצוני!

הצניחות החדה באפריל 2017 מצביעה על עלייה משמעותית במחירים בפועל לעומת המחירים המקוריים בחודש זה.
עליית מחירים זו יכולה הייתה לתרום לירידה בשיעורי התפוסה שנצפתה באותה תקופה, שכן מחירים גבוהים יותר עשויים להרתיע שוכרים פוטנציאליים.

## Red part analysis

נלקח מהצאט ונדרש עריכה

Red Period: Abnormal Drop in Occupancy and Price Spike (April 2017)
  Abnormal Behavior:
  A significant spike in the average daily price occurred in April 2017, followed by a noticeable drop in the occupancy rate.

Supporting Graph:
  The "Daily Average Price" graph shows a clear increase in prices during April 2017, while the "Daily Occupancy Rate" graph shows a corresponding decrease in occupancy.

Possible Reasons:
  1. Market Dynamics: A sudden increase in prices could result from a change in market conditions, 
    such as high demand during a specific event or season, causing hosts to raise prices.
  2. Data Entry Errors: This period could include data entry errors where prices were mistakenly recorded at higher levels.
  3. Special Events: Large-scale events, conventions, or other special events could drive up demand and prices temporarily.
  4. Policy Changes: Changes in Airbnb policies or local regulations could impact pricing and occupancy.

Handling Abnormal Values:
  1. Data Validation: Verify the accuracy of the price data during this period to ensure there are no entry errors.
  2. Contextual Investigation: Investigate external factors such as events, policy changes, or market trends that could explain the price spike.
  3. Adjustments or Removal: If these values are determined to be anomalies due to data errors, they should be corrected or removed. 
    If they represent real market behavior, they should be noted but not adjusted, as they provide valuable insights.
    
אירועים מיוחדים באותו זמן:
1. This is the end spring break.
2. https://en.wikipedia.org/wiki/2017_Boston_Marathon - מרתון בוסטון ב17 באפריל

הסתכלות רק על החלק האדום.


```{r}
# Create a graph focusing on the abnormal period
ggplot(daily_occupancy, aes(x = date, y = occupancy_rate)) +
  geom_line(color = "blue", size = 1) +
  geom_point(color = "blue", size = 1) +
  labs(title = "Daily Occupancy Rate (Highlighting Abnormal Period)",
       x = "Date",
       y = "Occupancy Rate (%)") +
  scale_x_date(date_labels = "%b %Y", date_breaks = "1 month") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylim(0, 100) +
  annotate("rect", xmin = as.Date("2017-04-01"), xmax = as.Date("2017-04-30"),
           ymin = 0, ymax = 100, alpha = 0.2, fill = "red") +
  annotate("text", x = as.Date("2017-04-15"), y = 80, label = "Abnormal Drop", color = "red", size = 4)
```
```{r}
# Plotting the daily average price with full annotation
ggplot(average_price_per_day, aes(x = date, y = average_price)) +
  geom_line(color = "green", size = 1) +
  geom_point(color = "green", size = 1) +
  labs(title = "Daily Average Price",
       x = "Date",
       y = "Average Price ($)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylim(0, max(average_price_per_day$average_price, na.rm = TRUE) * 1.1) +  # Extend y-axis slightly
  annotate("rect", xmin = as.Date("2017-04-01"), xmax = as.Date("2017-04-30"),
           ymin = 0, ymax = max(average_price_per_day$average_price, na.rm = TRUE) * 1.1, alpha = 0.2, fill = "red") +
  annotate("text", x = as.Date("2017-04-15"), y = max(average_price_per_day$average_price, na.rm = TRUE), 
           label = "Jump in prices", color = "red", size = 4)
```
נסתכל על ההבדל בין מחיר הקלוג לפועל
```{r}
# Filter data for the specified period
discount_data <- merged_data %>%
  filter(date >= as.Date("2017-04-01") & date <= as.Date("2017-04-30")) %>%
  select(date, listing_id, price_dollars, org_price)

# Calculate the difference in prices
discount_data <- discount_data %>%
  mutate(diff_price = org_price - price_dollars)

# View the first few rows of the data table
discount_data

```
נראה שיש דווקא הבדלים!
(למעלה יש גרף שמציג את ההבדלים)

נסתכל על הטופ של הנכסים עם ההבדלים היו גדולים ונציג אותם על פני הגרף

```{r}
# Filter data for the specified period
discount_data <- merged_data %>%
  filter(date >= as.Date("2017-04-01") & date <= as.Date("2017-04-30")) %>%
  select(date, listing_id, price_dollars, org_price)

# Calculate the difference in prices
discount_data <- discount_data %>%
  mutate(diff_price = org_price - price_dollars)

# Calculate the absolute difference in prices
discount_data <- discount_data %>%
  mutate(abs_diff_price = abs(diff_price))

# Find the listings with the highest absolute difference in prices
top_highest_listings <- discount_data %>%
  arrange(desc(abs_diff_price))

# View the top listings
top_highest_listings
```

the listing_id with the highest absolute difference in prices:
1. 11866651: from 350 to 3000
2. 6838488: from 550 to 2895
3. 7633883: from 769 to 2383
4. 11371205: from 200 to 1500
5. 12425501: from 200 to 1500
6. 14215317

נציג על גרף את ההבדלים עבור אותם נכנסים במשך כל הימים כדי לראות את ההבדלים והאם ההבדל בחודש אפריל 2017 היה קיצוני
```{r}
# Define the listing IDs of interest
listing_ids <- c(11866651, 6838488, 7633883, 11371205, 12425501, 14215317)

# Filter the data for the specified listings
filtered_data <- merged_data %>%
  filter(listing_id %in% listing_ids) %>%
  select(date, listing_id, price_dollars, org_price)

# Calculate the difference in prices
filtered_data <- filtered_data %>%
  mutate(price_diff = org_price - price_dollars)

# Plot the price differences over time for the specified listings
ggplot(filtered_data, aes(x = date, y = price_diff, color = as.factor(listing_id))) +
  geom_line(size = 1) +
  geom_point(size = 1) +
  scale_color_manual(values = c("11866651" = "red", "6838488" = "pink", "7633883" = "green", "11371205" = "purple", "12425501" = "orange", "14215317" = "lightblue")) +
  labs(title = "Price Differences Over Time for Selected Listings",
       x = "Date",
       y = "Price Difference ($)",
       color = "Listing ID") +
  scale_x_date(date_labels = "%b %Y", date_breaks = "1 month") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r echo=TRUE, fig.width=18, fig.height=12}
# Ensure required libraries are loaded
library(dplyr)
library(ggplot2)

# Define the listing IDs of interest
listing_ids <- c(11866651, 6838488, 7633883, 11371205, 12425501, 14215317)

# Filter the data for the specified listings
filtered_data <- merged_data %>%
  filter(listing_id %in% listing_ids) %>%
  select(date, listing_id, price_dollars, org_price)

# Calculate the difference in prices
filtered_data <- filtered_data %>%
  mutate(price_diff = org_price - price_dollars)

# Plot the price differences over time for the specified listings
ggplot(filtered_data, aes(x = date, y = price_diff, color = as.factor(listing_id))) +
  geom_line(size = 1) +
  geom_point(size = 1) +
  scale_color_manual(values = c("11866651" = "red", "6838488" = "pink", "7633883" = "green", "11371205" = "purple", "12425501" = "orange", "14215317" = "lightblue")) +
  labs(title = "Price Differences Over Time for Selected Listings",
       x = "Date",
       y = "Price Difference ($)",
       color = "Listing ID") +
  scale_x_date(date_labels = "%b %d", date_breaks = "10 days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```


נראה ש
1. 6838488 מעלה ומוריד מחירים במשך כל שנת 2017
2. עבור כל השאר נראה שיש עליית מחירים לעומת מה שהיה קודם בדיוק סביב מרתון בוסטון שהיה ב 17 באפריל 2017
3. 7633883 מאוד תנודתי


-> אפשר להעיף את הרעש האדום ולראות את ההשפעה


נסתכל על ההסבר שלהם
```{r}
dd_6838488 <- listings_data %>%
  filter(id == 6838488) 
dd_6838488$summary
```
```{r}
dd_7633883 <- listings_data %>%
  filter(id == 7633883) 
dd_7633883$summary
```
```{r}
dd_11371205 <- listings_data %>%
  filter(id == 11371205) 
dd_11371205$summary
```
```{r}
dd_11866651 <- listings_data %>%
  filter(id == 11866651) 
dd_11866651$summary
```
```{r}
dd_12425501 <- listings_data %>%
  filter(id == 12425501) 
dd_12425501$summary
```


```{r}
# Filter the data for the specific time period and availability category
april_data <- merged_data %>% 
  filter(date >= as.Date("2017-04-01") & date <= as.Date("2017-04-30") & available_category == 1)

# Calculate the differences between org_price and price_dollars for the filtered data
april_data$price_difference <- april_data$org_price - april_data$price_dollars

# Create a line plot to visualize the differences over the specified time period
ggplot(april_data, aes(x = date, y = price_difference)) +
  geom_line(color = "blue", size = 1) +
  geom_point(color = "blue", size = 1) +
  labs(title = "Differences Between Original Price and Actual Price in Dollars (April 2017)",
       x = "Date",
       y = "Price Difference ($)") +
  scale_x_date(date_labels = "%b %d", date_breaks = "1 day") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
In the graph, the y-axis represents the difference between the original price (org_price) and the actual price in dollars (price_dollars). If the difference is negative, it means that the actual price paid for the listing was higher than the original price. In other words, the host increased the price above the initial listing price.

Conversely, if the difference is positive, it means that the actual price paid was lower than the original price, indicating that the host provided a discount on the original listing price.

The negative values indicate that the host might have adjusted the prices upwards, possibly due to higher demand or special events during that period.

בגדול רואים שברוב הימים העלו את מחירי הנכסים לעומת המחיר הראשוני ששמו באתר.

(דיברנו על זה למעלה)


נסתכל על קבוצת הנכסים שכל נכס נכנס אליה עבור נכסים שהושכרו בחודש הזה
```{r}
# Filter data for the specified date range and rented listings
filtered_data <- merged_data %>%
  filter(date >= as.Date("2017-04-01") & date <= as.Date("2017-04-30") & available_category == 1)

# Calculate the percentage distribution of listings in each price group
price_group_distribution <- filtered_data %>%
  group_by(price_group) %>%
  summarise(count = n()) %>%
  mutate(percentage = count / sum(count) * 100)

# Create a bar plot to visualize the distribution
ggplot(price_group_distribution, aes(x = price_group, y = percentage, fill = price_group)) +
  geom_bar(stat = "identity") +
  labs(title = "Percentage Distribution of Rented Listings by Price Group (April 2017)",
       x = "Price Group",
       y = "Percentage of Rented Listings (%)") +
  theme_minimal() +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  scale_fill_manual(values = c("Low Price" = "blue", "Medium Price" = "green", "Expensive" = "red"))

```
רוב הנכסים שהושכרו באותו חודש היו בעלי מחיר ממוצע.
ניסיתי לראות אולי בחודש הזה נמכרו נכסים שהם באופן כללי יקרים מהרגיל



נסתכל על מחירי כל נכס שהוצעו להשכרה באותו החודש המוזר

```{r}
# Filter the data for the specified period
falling_prices_period <- merged_data %>%
  filter(date >= as.Date("2017-04-01") & date <= as.Date("2017-04-30"))
```

נסתכל על המחירים של אותם נכסים אותו החודש

```{r}
# Create the plot
ggplot(falling_prices_period, aes(x = date, y = price_dollars)) +
  geom_point(color = "blue", size = 2) +
  labs(title = "Listing Prices During April 2017 with Falling Prices",
       x = "Date",
       y = "Price ($)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
זה הנכס שמחירו 4000

```{r}
# Finding the row with a price of $4000
listing_4000 <- merged_data %>%
  filter(price_dollars == 4000)

# Display the row
print(listing_4000)

```
```{r}
listing_4000$listing_id
```


Analyze by Neighborhood:

Determine if certain neighborhoods have driven the price increase. You can compare the average prices in different neighborhoods during the period.

```{r}
# Calculate average price per neighborhood during the period
average_price_neighbourhood <- merged_data %>%
  filter(date >= as.Date("2017-04-01") & date <= as.Date("2017-04-30")) %>%
  group_by(neighbourhood) %>%
  summarize(average_price = mean(price_dollars, na.rm = TRUE))

# Plot average price per neighborhood
ggplot(average_price_neighbourhood, aes(x = reorder(neighbourhood, -average_price), y = average_price)) +
  geom_bar(stat = "identity", fill = "blue") +
  coord_flip() +
  labs(title = "Average Price by Neighborhood in April 2017", x = "Neighborhood", y = "Average Price ($)")

```

```{r}
# Extracting prices for April 2017
april_prices <- merged_data$price_dollars[merged_data$date >= as.Date("2017-04-01") & merged_data$date <= as.Date("2017-04-30")]
april_prices
```
```{r}
# Create a histogram for the prices in April 2017
hist(april_prices, 
     breaks = 50, 
     col = "blue", 
     main = "Histogram of Prices in April 2017", 
     xlab = "Price ($)", 
     ylab = "Frequency", 
     border = "black")
```
```{r}
boxplot(april_prices, main = "Boxplot of Prices in April 2017", ylab = "Price ($)")
```


## Green part analysis

כנראה נוותר על החלק הזה!

* Green Period: Increase in Occupancy and Price Drop (September 2016 - December 2016)
Abnormal Behavior:
  During this period, there is a significant and sustained increase in the occupancy rate, along with a noticeable drop in average daily prices. 
  This trend of increased occupancy and decreased prices is consistent over several months.

Supporting Graph:
  The "Daily Occupancy Rate" graph shows a steady increase in occupancy (מגמת עליה), 
  while the "Daily Average Price" graph indicates a declining trend in prices during this time frame.
  
Possible Reasons:
  1. Seasonal Variation: The observed increase in occupancy and decrease in prices could be influenced by seasonal factors, 
    such as an off-peak tourist season where lower prices are set to attract more bookings.
  2. Promotional Events or Discounts: Hosts may have offered promotions or discounts, resulting in lower prices and higher occupancy rates.
  3. Market Adjustment: A market adjustment period where prices were reduced to align with demand fluctuations.
  4. Data Entry Errors: Though consistent trends are less likely to result from data entry errors, it's still possible that some anomalies exist.

Handling Abnormal Values:
  1. Verification: Confirming the accuracy of the data by comparing it with external events, promotions, or seasonal trends.
  2. Contextual Analysis: Gaining insight into the local market conditions, events, 
    or changes in policy can help understand whether these values represent true seasonal trends or anomalies.
  3. Data Cleaning: If identified as erroneous data, these values should be corrected or flagged. If they reflect actual market behavior, they should be         noted for strategic analysis, rather than removed, as they provide insights into market dynamics.


To investigate whether hosts offered discounts during the period from September 2016 to December 2016, we can compare the dollars_Price (actual price listed) with the org_price (original price before any discounts). Here's the R code to create a table with the required information and plot a graph to visualize any differences:


```{r}
# Filter data for the specified period
discount_data <- merged_data %>%
  filter(date >= as.Date("2016-09-01") & date <= as.Date("2016-12-31")) %>%
  select(date, listing_id, price_dollars, org_price)

# Calculate the difference in prices
discount_data <- discount_data %>%
  mutate(diff_price = org_price - price_dollars)

# View the first few rows of the data table
discount_data

```



-----------------------------------

-----------------------------------

## Second Part

The second part is clearing outliers for:
1. Beds
2. Price

נזכור שקודם נרצה לטפל בערכים החסרים!
### Beds

```{r}
#TODO

# Count the number of listings for each number of beds
bed_counts <- listings_data %>%
  group_by(beds) %>%
  summarise(count = n()) %>%
  arrange(beds)

# Print the bed counts
print(bed_counts)

```

```{r}
# Bar plot to visualize the counts of each number of beds with numbers above each bar
ggplot(bed_counts, aes(x = beds, y = count)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = count), vjust = -0.5, size = 3.5) +
  labs(title = "Number of Listings for Each Number of Beds",
       x = "Number of Beds",
       y = "Count of Listings") +
  theme_minimal()

```
Looks like there is one with 16 beds.
Let's look at its description maybe we can draw some new conclusions:


```{r}
# Filter listings with 16 beds
listings_16_beds <- listings_data %>%
  filter(beds == 16)

# Print the descriptions of listings with 16 beds
print(listings_16_beds$summary)

```
Not an outlier! Just a unique room :)

```{r}
# Filter listings with 16 beds
listings_9_beds <- listings_data %>%
  filter(beds == 9)

# Print the descriptions of listings with 16 beds
print(listings_9_beds$summary)

```


```{r}
# Filter listings with 16 beds
listings_0_beds <- listings_data %>%
  filter(beds == 0) 

# Print the descriptions of listings with 16 beds
print(listings_0_beds$summary)

```


```{r options(repr.plot.width = 15, repr.plot.height = 10)}

# Count the number of listings for each number of beds in each neighborhood
bed_counts_neighborhood <- listings_data %>%
  group_by(neighbourhood, beds) %>%
  summarise(count = n()) %>%
  arrange(neighbourhood, beds)

# Print the bed counts per neighborhood
print(bed_counts_neighborhood)

# Bar plot to visualize the counts of each number of beds for each neighborhood
ggplot(bed_counts_neighborhood, aes(x = factor(beds), y = count)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = count), vjust = -0.5, size = 3.5) +
  facet_wrap(~ neighbourhood, scales = "free_y") +
  labs(title = "Number of Listings for Each Number of Beds in Each Neighborhood",
       x = "Number of Beds",
       y = "Count of Listings") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r}
# Calculate average number of beds for each neighborhood
avg_beds_neighborhood <- listings %>%
  group_by(neighbourhood) %>%
  summarise(avg_beds = mean(beds, na.rm = TRUE)) %>%
  arrange(desc(avg_beds))

# Print the average number of beds
print(avg_beds_neighborhood)
```
```{r}
# Bar plot to visualize the average number of beds per neighborhood
ggplot(avg_beds_neighborhood, aes(x = reorder(neighbourhood, avg_beds), y = avg_beds)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  geom_text(aes(label = round(avg_beds, 2)), vjust = -0.5, size = 3.5) +
  labs(title = "Average Number of Beds by Neighborhood",
       x = "Neighborhood",
       y = "Average Number of Beds") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8)) +
  theme(plot.title = element_text(size = 14, face = "bold"),
        axis.title = element_text(size = 12))
```


```{r}
# Calculate the number of listings for each neighborhood
listings_per_neighborhood <- listings %>%
  group_by(neighbourhood) %>%
  summarise(num_listings = n()) %>%
  arrange(desc(num_listings))

# Print the number of listings per neighborhood
print(listings_per_neighborhood)
```
```{r}
# Bar plot to visualize the number of listings per neighborhood
ggplot(listings_per_neighborhood, aes(x = reorder(neighbourhood, num_listings), y = num_listings)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  geom_text(aes(label = num_listings), vjust = -0.5, size = 3.5) +
  labs(title = "Number of Listings by Neighborhood",
       x = "Neighborhood",
       y = "Number of Listings") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8)) +
  theme(plot.title = element_text(size = 14, face = "bold"),
        axis.title = element_text(size = 12))
```
We can see that harvard is high since there are only 2 listings in that neighborhood

```{r}

# Calculate the average number of listings
avg_listings <- mean(listings_per_neighborhood$num_listings)

# Print the number of listings per neighborhood and the average number of listings
print(paste("Average number of listings per neighborhood:", round(avg_listings, 2)))
```



### Price


```{r , echo=TRUE, fig.width=18, fig.height=12}

# Create bins for the price_dollars
listings <- listings_data %>%
  mutate(price_bin = cut(price_dollars, breaks = seq(0, max(price_dollars, na.rm = TRUE), by = 50), include.lowest = TRUE))

# Count the number of listings in each price bin
price_counts <- listings %>%
  group_by(price_bin) %>%
  summarise(count = n())

# Print the price counts
print(price_counts)

# Bar plot to visualize the distribution of listing prices
ggplot(price_counts, aes(x = price_bin, y = count)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = count), vjust = -0.5, size = 3.5) +
  labs(title = "Distribution of Listing Prices",
       x = "Price (in dollars)",
       y = "Count of Listings") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```


```{r}
# Define the price threshold
threshold <- 1000

# Filter listings with price_dollars above the threshold
expensive_listings <- listings %>%
  filter(price_dollars > threshold)

# Sort the filtered listings by price_dollars in descending order
sorted_expensive_listings <- expensive_listings %>%
  arrange(desc(price_dollars))

# Print the sorted listings
print(sorted_expensive_listings)
```



```{r}

# Calculate average price_dollars for each neighborhood
avg_price_neighborhood <- listings %>%
  group_by(neighbourhood) %>%
  summarise(avg_price = mean(price_dollars, na.rm = TRUE)) %>%
  arrange(desc(avg_price))

# Print the average prices
print(avg_price_neighborhood)

# Bar plot to visualize the average price_dollars per neighborhood
ggplot(avg_price_neighborhood, aes(x = reorder(neighbourhood, avg_price), y = avg_price)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  geom_text(aes(label = round(avg_price, 2)), vjust = -0.5, size = 3.5) +
  labs(title = "Average Listing Price by Neighborhood",
       x = "Neighborhood",
       y = "Average Price (in dollars)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```


```{r}
# Scatter plot to visualize all listing prices by neighborhood
ggplot(listings, aes(x = reorder(neighbourhood, price_dollars, median), y = price_dollars)) +
  geom_point(alpha = 0.6, color = "blue") +
  labs(title = "Listing Prices by Neighborhood",
       x = "Neighborhood",
       y = "Price (in dollars)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


```{r}

# Filter listings with 16 beds
dd1 <- listings_data %>%
  filter(id == 12972378) 
dd1$summary
# # Print the descriptions of listings with 16 beds
# print(listings_16_beds$summary)

```


```{r}

# Filter listings with 16 beds
dd2 <- listings_data %>%
  filter(id == 7633883
) 
dd2$summary
# # Print the descriptions of listings with 16 beds
# print(listings_16_beds$summary)

```

```{r}

# Filter listings with 16 beds
dd3 <- listings_data %>%
  filter(id == 11866651) 
dd3$summary
# # Print the descriptions of listings with 16 beds
# print(listings_16_beds$summary)

```